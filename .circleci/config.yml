# Scala CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/sample-config/ for more details
#
# Use the chisel3-tools image to build and run FIRRTL and chisel tests.
defaultImageUserWDEnv: &defaultImageUserWDEnv
  docker:
  - image: ucbbar/chisel3-tools
    user: "chisel"

  working_directory: ~/repo

  environment:
    # Customize the JVM maximum heap limit
    JVM_OPTS: -Xmx3200m
    TERM: dumb
    CHISEL_REV: origin/master
    FIRRTL_REPO: git@github.com:freechipsproject/firrtl.git
    FIRRTL_BRANCH: master
    FIRRTL_REV: master
    SBT_ARGS: ""


version: 2

jobs:
  build-prep:
    <<: *defaultImageUserWDEnv

    steps:

    # Perform a "default" checkout to get ssh set up.
    - checkout:
        path: chisel3

    - run:
        command: |
          date > date.prep
          printenv
          ls -l
          git clone --depth 10 --branch $FIRRTL_BRANCH "$FIRRTL_REPO" firrtl && (cd firrtl && git checkout $FIRRTL_REV)
          echo $FIRRTL_REV && (cd firrtl && git log -1 > ../firrtl.log)

    - save_cache:
        paths:
        - ~/.ssh
        key: v1-dependencies-{{ .Branch }}-{{ .Revision }}-{{ checksum "firrtl.log" }}

    - persist_to_workspace:
        root: /home/chisel
        paths:
        - repo
        - .ivy2
        - .m2
        - .sbt

  build-firrtl:
    <<: *defaultImageUserWDEnv

    steps:
    - attach_workspace:
        at: /home/chisel

    - restore_cache:
        keys:
        - v1-dependencies-{{ .Branch }}-{{ .Revision }}-{{ checksum "firrtl.log" }}
        # fallback to using the latest cache if no exact match is found
        - v1-dependencies-

    # publish FIRRTL
    - run:
        command: |
          date > date.firrtl
          (cd firrtl && cat /dev/null | sbt $SBT_ARGS +publishLocal)

    - persist_to_workspace:
        root: /home/chisel
        paths:
        - repo
        - .ivy2
        - .m2
        - .sbt

  # Define a pure build chisel - currently unused since we can compile and test chisel in one step
  #  and we don't have downstream jobs that need the published version of chisel.
  build-chisel:
    <<: *defaultImageUserWDEnv

    steps:
    - attach_workspace:
        at: /home/chisel
    # Download and cache dependencies
    - restore_cache:
        keys:
        - v1-dependencies-{{ .Branch }}-{{ .Revision }}-{{ checksum "firrtl.log" }}
        # fallback to using the latest cache if no exact match is found
        - v1-dependencies-

    # publish chisel
    - run: date > date.chisel3 && (cd chisel3 && sbt $SBT_ARGS +publishLocal)

    - persist_to_workspace:
        root: /home/chisel
        paths:
        - repo
        - .ivy2
        - .m2
        - .sbt

  test-chisel:
    <<: *defaultImageUserWDEnv

    steps:
    - attach_workspace:
        at: /home/chisel
    - restore_cache:
        keys:
        - v1-dependencies-{{ .Branch }}-{{ .Revision }}-{{ checksum "firrtl.log" }}
        # fallback to using the latest cache if no exact match is found
        - v1-dependencies-

    # Set environment
    - run: echo 'export PATH="/opt/verilator/verilator_3_922/bin:/opt/yosys/bin:$PATH"' >> $BASH_ENV

    - run:
        command: |
          (cd chisel3 && sbt $SBT_ARGS +test)

  checkstyle-chisel:
    <<: *defaultImageUserWDEnv

    steps:
    - attach_workspace:
        at: /home/chisel
    - restore_cache:
        keys:
        - v1-dependencies-{{ .Branch }}-{{ .Revision }}-{{ checksum "firrtl.log" }}
        # fallback to using the latest cache if no exact match is found
        - v1-dependencies-

    - run:
        command: |
          (cd chisel3 && sbt $SBT_ARGS scalastyle  test:scalastyle)

workflows:
  version: 2

  build_and_test:
    jobs:
    - build-prep
    - build-firrtl:
        requires:
        - build-prep
    - test-chisel:
        requires:
        - build-firrtl
    - checkstyle-chisel:
        requires:
        - build-firrtl
