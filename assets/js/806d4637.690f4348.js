"use strict";(globalThis.webpackChunkchisel_lang=globalThis.webpackChunkchisel_lang||[]).push([[8485],{6539(e,n,i){i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>m,frontMatter:()=>t,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"cookbooks/serialization","title":"Serialization Cookbook","description":"Why do I need to serialize Modules","source":"@site/docs/cookbooks/serialization.md","sourceDirName":"cookbooks","slug":"/cookbooks/serialization","permalink":"/docs/cookbooks/serialization","draft":false,"unlisted":false,"editUrl":"https://github.com/chipsalliance/chisel/tree/main/docs/src/cookbooks/serialization.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"chiselSidebar","previous":{"title":"DataView Cookbook","permalink":"/docs/cookbooks/dataview"},"next":{"title":"ObjectModel Cookbook","permalink":"/docs/cookbooks/objectmodel"}}');var l=i(4848),o=i(8453),r=i(1871);const t={sidebar_position:4},s="Serialization Cookbook",d={},c=[{value:"Why do I need to serialize Modules",id:"why-do-i-need-to-serialize-modules",level:2},{value:"How do I serialize Modules with <code>SerializableModuleGenerator</code>",id:"how-do-i-serialize-modules-with-serializablemodulegenerator",level:2}];function u(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"serialization-cookbook",children:"Serialization Cookbook"})}),"\n","\n",(0,l.jsx)(r.A,{toc:c}),"\n",(0,l.jsx)(n.h2,{id:"why-do-i-need-to-serialize-modules",children:"Why do I need to serialize Modules"}),"\n",(0,l.jsxs)(n.p,{children:['Chisel provides a very flexible hardware design experience. However, it sometimes becomes too flexible to design a relative big designs, since parameters of module might come from: 1. Global variables; 2. Outer class; 3. Entropies(time, random). It becomes really hard or impossible to describe "how to reproduce this single module?". This forbids doing unit-test for a module generator, and introduces issues in post-synthesis when doing ECO: a change to Module A might lead to change in Module B.\nThus ',(0,l.jsx)(n.code,{children:"SerializableModuleGenerator"}),", ",(0,l.jsx)(n.code,{children:"SerializableModule[T <: SerializableModuleParameter]"})," and ",(0,l.jsx)(n.code,{children:"SerializableModuleParameter"})," are provided to solve these issues.\nFor any ",(0,l.jsx)(n.code,{children:"SerializableModuleGenerator"}),", Chisel can automatically serialize and de-serialize it by adding these constraints:"]}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["the ",(0,l.jsx)(n.code,{children:"SerializableModule"})," should not be inner class, since the outer class is a parameter to it;"]}),"\n",(0,l.jsxs)(n.li,{children:["the ",(0,l.jsx)(n.code,{children:"SerializableModule"})," has and only has one parameter with ",(0,l.jsx)(n.code,{children:"SerializableModuleParameter"})," as its type."]}),"\n",(0,l.jsx)(n.li,{children:"the Module neither depends on global variables nor uses non-reproducible functions(random, time, etc), and this should be guaranteed by user, since Scala cannot detect it."}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"It can provide these benefits:"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["user can use ",(0,l.jsx)(n.code,{children:"SerializableModuleGenerator(module: class[SerializableModule], parameter: SerializableModuleParameter)"})," to auto serialize a Module and its parameter."]}),"\n",(0,l.jsxs)(n.li,{children:["user can nest ",(0,l.jsx)(n.code,{children:"SerializableModuleGenerator"})," in other serializable parameters to represent a relative large parameter."]}),"\n",(0,l.jsxs)(n.li,{children:["user can elaborate any ",(0,l.jsx)(n.code,{children:"SerializableModuleGenerator"})," into a single module for testing."]}),"\n"]}),"\n",(0,l.jsxs)(n.h2,{id:"how-do-i-serialize-modules-with-serializablemodulegenerator",children:["How do I serialize Modules with ",(0,l.jsx)(n.code,{children:"SerializableModuleGenerator"})]}),"\n",(0,l.jsxs)(n.p,{children:["It is pretty simple and illustrated by example below, the ",(0,l.jsx)(n.code,{children:"GCD"})," Module with ",(0,l.jsx)(n.code,{children:"width"})," as its parameter."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-scala",children:"import chisel3._\nimport chisel3.experimental.{SerializableModule, SerializableModuleGenerator, SerializableModuleParameter}\nimport upickle.default._\n\n// provide serialization functions to GCDSerializableModuleParameter\nobject GCDSerializableModuleParameter {\n  implicit def rwP: ReadWriter[GCDSerializableModuleParameter] = macroRW\n}\n\n// Parameter\ncase class GCDSerializableModuleParameter(width: Int) extends SerializableModuleParameter\n\n// Module\nclass GCDSerializableModule(val parameter: GCDSerializableModuleParameter)\n    extends Module\n    with SerializableModule[GCDSerializableModuleParameter] {\n  val io = IO(new Bundle {\n    val a = Input(UInt(parameter.width.W))\n    val b = Input(UInt(parameter.width.W))\n    val e = Input(Bool())\n    val z = Output(UInt(parameter.width.W))\n  })\n  val x = Reg(UInt(parameter.width.W))\n  val y = Reg(UInt(parameter.width.W))\n  val z = Reg(UInt(parameter.width.W))\n  val e = Reg(Bool())\n  when(e) {\n    x := io.a\n    y := io.b\n    z := 0.U\n  }\n  when(x =/= y) {\n    when(x > y) {\n      x := x - y\n    }.otherwise {\n      y := y - x\n    }\n  }.otherwise {\n    z := x\n  }\n  io.z := z\n}\n"})}),"\n",(0,l.jsxs)(n.p,{children:["using ",(0,l.jsx)(n.code,{children:"write"})," function in ",(0,l.jsx)(n.code,{children:"upickle"}),", it should return a json string:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-scala",children:'val j = upickle.default.write(\n  SerializableModuleGenerator(\n    classOf[GCDSerializableModule],\n    GCDSerializableModuleParameter(32)\n  )\n)\n// j: String = "{\\"parameter\\":{\\"width\\":32},\\"generator\\":\\"repl.MdocSession$MdocApp$GCDSerializableModule\\"}"\n'})}),"\n",(0,l.jsx)(n.p,{children:"You can then read from json string and elaborate the Module:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-scala",children:"circt.stage.ChiselStage.emitSystemVerilog(\n  upickle.default.read[SerializableModuleGenerator[GCDSerializableModule, GCDSerializableModuleParameter]](\n    ujson.read(j)\n  ).module()\n)\n"})})]})}function m(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(u,{...e})}):u(e)}},1871(e,n,i){i.d(n,{A:()=>r});i(6540);var a=i(5195);const l="tableOfContentsInline_prmo";var o=i(4848);function r({toc:e,minHeadingLevel:n,maxHeadingLevel:i}){return(0,o.jsx)("div",{className:l,children:(0,o.jsx)(a.A,{toc:e,minHeadingLevel:n,maxHeadingLevel:i,className:"table-of-contents",linkClassName:null})})}},5195(e,n,i){i.d(n,{A:()=>p});var a=i(6540),l=i(6342);function o(e){const n=e.map(e=>({...e,parentIndex:-1,children:[]})),i=Array(7).fill(-1);n.forEach((e,n)=>{const a=i.slice(2,e.level);e.parentIndex=Math.max(...a),i[e.level]=n});const a=[];return n.forEach(e=>{const{parentIndex:i,...l}=e;i>=0?n[i].children.push(l):a.push(l)}),a}function r({toc:e,minHeadingLevel:n,maxHeadingLevel:i}){return e.flatMap(e=>{const a=r({toc:e.children,minHeadingLevel:n,maxHeadingLevel:i});return function(e){return e.level>=n&&e.level<=i}(e)?[{...e,children:a}]:a})}function t(e){const n=e.getBoundingClientRect();return n.top===n.bottom?t(e.parentNode):n}function s(e,{anchorTopOffset:n}){const i=e.find(e=>t(e).top>=n);if(i){return function(e){return e.top>0&&e.bottom<window.innerHeight/2}(t(i))?i:e[e.indexOf(i)-1]??null}return e[e.length-1]??null}function d(){const e=(0,a.useRef)(0),{navbar:{hideOnScroll:n}}=(0,l.p)();return(0,a.useEffect)(()=>{e.current=n?0:document.querySelector(".navbar").clientHeight},[n]),e}function c(e){const n=(0,a.useRef)(void 0),i=d();(0,a.useEffect)(()=>{if(!e)return()=>{};const{linkClassName:a,linkActiveClassName:l,minHeadingLevel:o,maxHeadingLevel:r}=e;function t(){const e=function(e){return Array.from(document.getElementsByClassName(e))}(a),t=function({minHeadingLevel:e,maxHeadingLevel:n}){const i=[];for(let a=e;a<=n;a+=1)i.push(`h${a}.anchor`);return Array.from(document.querySelectorAll(i.join()))}({minHeadingLevel:o,maxHeadingLevel:r}),d=s(t,{anchorTopOffset:i.current}),c=e.find(e=>d&&d.id===function(e){return decodeURIComponent(e.href.substring(e.href.indexOf("#")+1))}(e));e.forEach(e=>{!function(e,i){i?(n.current&&n.current!==e&&n.current.classList.remove(l),e.classList.add(l),n.current=e):e.classList.remove(l)}(e,e===c)})}return document.addEventListener("scroll",t),document.addEventListener("resize",t),t(),()=>{document.removeEventListener("scroll",t),document.removeEventListener("resize",t)}},[e,i])}var u=i(8774),m=i(4848);function h({toc:e,className:n,linkClassName:i,isChild:a}){return e.length?(0,m.jsx)("ul",{className:a?void 0:n,children:e.map(e=>(0,m.jsxs)("li",{children:[(0,m.jsx)(u.A,{to:`#${e.id}`,className:i??void 0,dangerouslySetInnerHTML:{__html:e.value}}),(0,m.jsx)(h,{isChild:!0,toc:e.children,className:n,linkClassName:i})]},e.id))}):null}const b=a.memo(h);function p({toc:e,className:n="table-of-contents table-of-contents__left-border",linkClassName:i="table-of-contents__link",linkActiveClassName:t,minHeadingLevel:s,maxHeadingLevel:d,...u}){const h=(0,l.p)(),p=s??h.tableOfContents.minHeadingLevel,x=d??h.tableOfContents.maxHeadingLevel,v=function({toc:e,minHeadingLevel:n,maxHeadingLevel:i}){return(0,a.useMemo)(()=>r({toc:o(e),minHeadingLevel:n,maxHeadingLevel:i}),[e,n,i])}({toc:e,minHeadingLevel:p,maxHeadingLevel:x});return c((0,a.useMemo)(()=>{if(i&&t)return{linkClassName:i,linkActiveClassName:t,minHeadingLevel:p,maxHeadingLevel:x}},[i,t,p,x])),(0,m.jsx)(b,{toc:v,className:n,linkClassName:i,...u})}},8453(e,n,i){i.d(n,{R:()=>r,x:()=>t});var a=i(6540);const l={},o=a.createContext(l);function r(e){const n=a.useContext(o);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:r(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);